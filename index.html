<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualiseur de Heatmaps</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
    }
    .heatmap {
      width: 385px;
      height: 385px;
      background-color: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      margin: 20px auto;
    }
    img {
      max-width: 100%;
      max-height: 100%;
    }
    select, input, button {
      background-color: #333;
      color: white;
      border: 1px solid #555;
      margin: 5px;
    }
    progress {
      width: 100%;
      height: 20px;
      margin-top: 10px;
      display: none;
    }
    #gameInfo {
      margin-top: 20px;
      font-size: 0.9em;
    }
    #contactInfo {
      margin-top: 10px;
      font-size: 0.8em;
    }
    #contactInfo a {
      color: #4da6ff;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visualiseur de Heatmaps</h1>

    <div class="heatmap">
      <img id="heatmapImage" src="" alt="Heatmap non disponible">
    </div>

    <!-- Barre de chargement -->
    <progress id="preloadProgress" max="478" value="0"></progress>

    <label for="timeInput">Temps (secondes) :</label>
    <input type="number" id="timeInput" min="0" max="500" value="0">
    <input type="range" id="timeSlider" min="0" max="500" value="0">

    <br><br>

    <label for="teamSelect">Team :</label>
    <select id="teamSelect">
      <option value="all">all</option>
      <option value="red">red</option>
      <option value="blue">blue</option>
    </select>

    <label for="wardSelect">Type de Ward :</label>
    <select id="wardSelect">
      <option value="all">all</option>
      <option value="ward">ward</option>
      <option value="pink">pink</option>
    </select>
    
    <br><br>
    
    <label for="speedSelect">Vitesse :</label>
    <select id="speedSelect">
      <option value="5">5x</option>
      <option value="10">10x</option>
      <option value="15">15x</option>
      <option value="20">20x</option>
    </select>

    <button id="playPauseButton">Play</button>

    <!-- Section pour afficher les infos du jeu -->
    <div id="gameInfo"></div>
    
    <!-- Section pour le message de contact, dont le contenu sera chargé depuis le JSON -->
    <div id="contactInfo"></div>
  </div>

  <script>
    const timeInput = document.getElementById("timeInput");
    const timeSlider = document.getElementById("timeSlider");
    const teamSelect = document.getElementById("teamSelect");
    const wardSelect = document.getElementById("wardSelect");
    const heatmapImage = document.getElementById("heatmapImage");
    const playPauseButton = document.getElementById("playPauseButton");
    const speedSelect = document.getElementById("speedSelect");
    const preloadProgress = document.getElementById("preloadProgress");
    const gameInfoDiv = document.getElementById("gameInfo");
    const contactInfoDiv = document.getElementById("contactInfo");

    let interval;
    let isPlaying = false;
    // Cache des images préchargées, indexé par clé (exemple "red_all")
    const cacheImages = {};

    // Fonction pour obtenir le chemin d'une image en fonction du temps et des filtres
    function getImagePath(time, team, wardType) {
      const minutes = String(Math.floor(time / 60)).padStart(2, '0');
      const seconds = String(time % 60).padStart(2, '0');
      return `heatmap_folder/team_${team}_ward_${wardType}/heatmap_${minutes}_${seconds}.jpg`;
    }

    // Préchargement complet pour un filtre donné, en stockant chaque image dans un objet indexé par timestamp
    function preloadAllImages(team, wardType) {
      const totalImages = 478;
      const key = `${team}_${wardType}`;
      cacheImages[key] = {}; // Utilisation d'un objet pour stocker les images par timestamp
      preloadProgress.max = totalImages;
      preloadProgress.value = 0;
      preloadProgress.style.display = 'block'; // Affiche la barre de progression

      let loadedCount = 0;
      const promises = [];

      for (let t = 0; t < totalImages; t++) {
        const imagePath = getImagePath(t, team, wardType);
        const promise = new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            loadedCount++;
            preloadProgress.value = loadedCount;
            resolve({ time: t, img: img });
          };
          img.onerror = () => {
            // Les images manquantes ne sont pas considérées comme des erreurs : on ne log pas d'erreur.
            loadedCount++;
            preloadProgress.value = loadedCount;
            resolve({ time: t, img: null });
          };
          img.src = imagePath;
        });
        promises.push(promise);
      }

      Promise.all(promises).then((results) => {
        results.forEach(result => {
          cacheImages[key][result.time] = result.img;
        });
        preloadProgress.style.display = 'none'; // Masque la barre de progression
        updateHeatmap();
      }).catch((error) => {
        console.error("Erreur lors du préchargement complet :", error);
        preloadProgress.style.display = 'none';
      });
    }

    // Mise à jour de l'image affichée en utilisant le cache si disponible
    function updateHeatmap() {
      const time = parseInt(timeInput.value);
      const team = teamSelect.value;
      const wardType = wardSelect.value;
      const key = `${team}_${wardType}`;
      const imagePath = getImagePath(time, team, wardType);

      // Définir le gestionnaire d'erreur AVANT d'assigner le src pour éviter les boucles
      heatmapImage.onerror = function() {
        this.onerror = null; // Désactive le gestionnaire pour éviter une récursion
        this.src = 'heatmap_folder/heatmap_defaut.jpg';
      };

      // Utilise l'image préchargée si disponible, sinon charge directement l'image (le fallback s'activera en cas d'erreur)
      if (cacheImages[key] && cacheImages[key][time] !== null) {
        heatmapImage.src = cacheImages[key][time].src;
      } else {
        heatmapImage.src = imagePath;
      }
    }

    function togglePlay() {
      if (isPlaying) {
        clearInterval(interval);
        playPauseButton.textContent = "Play";
      } else {
        interval = setInterval(() => {
          let newTime = parseInt(timeInput.value) + 1;
          if (newTime > 500) newTime = 0;
          timeInput.value = newTime;
          timeSlider.value = newTime;
          updateHeatmap();
        }, 1000 / parseFloat(speedSelect.value));
        playPauseButton.textContent = "Pause";
      }
      isPlaying = !isPlaying;
    }

    timeInput.addEventListener("input", () => {
      timeSlider.value = timeInput.value;
      updateHeatmap();
    });

    timeSlider.addEventListener("input", () => {
      timeInput.value = timeSlider.value;
      updateHeatmap();
    });

    teamSelect.addEventListener("change", () => {
      const team = teamSelect.value;
      const wardType = wardSelect.value;
      preloadAllImages(team, wardType);
      updateHeatmap();
    });

    wardSelect.addEventListener("change", () => {
      const team = teamSelect.value;
      const wardType = wardSelect.value;
      preloadAllImages(team, wardType);
      updateHeatmap();
    });

    speedSelect.addEventListener("change", () => {
      if (isPlaying) {
        clearInterval(interval);
        togglePlay();
        togglePlay();
      }
    });

    playPauseButton.addEventListener("click", togglePlay);

    // Précharger le filtre par défaut et charger le fichier JSON au chargement de la page
    window.addEventListener("load", () => {
      const team = teamSelect.value;
      const wardType = wardSelect.value;
      preloadAllImages(team, wardType);
      updateHeatmap();
      
      // Chargement du fichier JSON pour afficher les infos du jeu et le message de contact
      console.log("La page est chargée, lancement du fetch pour infos.json");
        fetch('infos.json')
          .then(response => response.json())
          .then(data => {
            console.log("Données JSON reçues :", data);
            gameInfoDiv.innerHTML = `
              <p>Game Version: ${data.version}</p>
              <p>Number of Games Studied: ${data.numGames}</p>
              <p>Rank: ${data.rank}</p>
              <p>Last Update: ${data.lastUpdate}</p>
            `;
            contactInfoDiv.innerHTML = data.contactMessage;
          })
          .catch(error => {
            console.error("Erreur lors du chargement des infos du jeu :", error);
          });

    });

    // Lancer/arrêter la lecture avec la barre espace
    document.addEventListener("keydown", (event) => {
      if (event.code === "Space") {
        event.preventDefault();
        togglePlay();
      }
    });
  </script>
</body>
</html>
