<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heatmap Viewer</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
    }
    .heatmap {
      width: 385px;
      height: 385px;
      background-color: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      margin: 20px auto;
    }
    img {
      max-width: 100%;
      max-height: 100%;
    }
    select, input, button {
      background-color: #333;
      color: white;
      border: 1px solid #555;
      margin: 5px;
    }
    progress {
      width: 100%;
      height: 20px;
      margin-top: 10px;
      display: none;
    }
    #gameInfo {
      margin-top: 20px;
      font-size: 0.9em;
    }
    #contactInfo {
      margin-top: 10px;
      font-size: 0.8em;
    }
    #contactInfo a {
      color: #4da6ff;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Heatmap Viewer</h1>

    <div class="heatmap">
      <img id="heatmapImage" src="" alt="Heatmap not available">
    </div>

    <!-- Progress Bar -->
    <progress id="preloadProgress" max="478" value="0"></progress>

    <label for="timeInput">Time (seconds):</label>
    <input type="number" id="timeInput" min="0" max="500" value="0">
    <input type="range" id="timeSlider" min="0" max="500" value="0">

    <br><br>

    <label for="teamSelect">Team:</label>
    <select id="teamSelect">
      <option value="all">all</option>
      <option value="red">red</option>
      <option value="blue">blue</option>
    </select>

    <label for="wardSelect">Ward Type:</label>
    <select id="wardSelect">
      <option value="all">all</option>
      <option value="ward">ward</option>
      <option value="pink">pink</option>
    </select>
    
    <br><br>
    
    <label for="speedSelect">Speed:</label>
    <select id="speedSelect">
      <option value="5">5x</option>
      <option value="10">10x</option>
      <option value="15">15x</option>
      <option value="20">20x</option>
    </select>

    <button id="playPauseButton">Play</button>

    <!-- Section to display game info -->
    <div id="gameInfo"></div>
    
    <!-- Section for the contact message (loaded from JSON) -->
    <div id="contactInfo"></div>
  </div>

  <script>
    const timeInput = document.getElementById("timeInput");
    const timeSlider = document.getElementById("timeSlider");
    const teamSelect = document.getElementById("teamSelect");
    const wardSelect = document.getElementById("wardSelect");
    const heatmapImage = document.getElementById("heatmapImage");
    const playPauseButton = document.getElementById("playPauseButton");
    const speedSelect = document.getElementById("speedSelect");
    const preloadProgress = document.getElementById("preloadProgress");
    const gameInfoDiv = document.getElementById("gameInfo");
    const contactInfoDiv = document.getElementById("contactInfo");

    let interval;
    let isPlaying = false;
    // Cache for preloaded images, indexed by key (e.g., "red_all")
    const cacheImages = {};

    // Function to obtain the image path based on time and filters
    function getImagePath(time, team, wardType) {
      const minutes = String(Math.floor(time / 60)).padStart(2, '0');
      const seconds = String(time % 60).padStart(2, '0');
      return `heatmap_folder/team_${team}_ward_${wardType}/heatmap_${minutes}_${seconds}.jpg`;
    }

    // Preload all images for a given filter, storing each image in an object indexed by timestamp
    function preloadAllImages(team, wardType) {
      const totalImages = 478;
      const key = `${team}_${wardType}`;
      cacheImages[key] = {}; // Using an object to store images by timestamp
      preloadProgress.max = totalImages;
      preloadProgress.value = 0;
      preloadProgress.style.display = 'block'; // Show the progress bar

      let loadedCount = 0;
      const promises = [];

      for (let t = 0; t < totalImages; t++) {
        const imagePath = getImagePath(t, team, wardType);
        const promise = new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            loadedCount++;
            preloadProgress.value = loadedCount;
            resolve({ time: t, img: img });
          };
          img.onerror = () => {
            // Missing images are not considered errors: no error is logged.
            loadedCount++;
            preloadProgress.value = loadedCount;
            resolve({ time: t, img: null });
          };
          img.src = imagePath;
        });
        promises.push(promise);
      }

      Promise.all(promises).then((results) => {
        results.forEach(result => {
          cacheImages[key][result.time] = result.img;
        });
        preloadProgress.style.display = 'none'; // Hide the progress bar
        updateHeatmap();
      }).catch((error) => {
        console.error("Error during image preloading:", error);
        preloadProgress.style.display = 'none';
      });
    }

    // Update the displayed image using the cache if available
    function updateHeatmap() {
      const time = parseInt(timeInput.value);
      const team = teamSelect.value;
      const wardType = wardSelect.value;
      const key = `${team}_${wardType}`;
      const imagePath = getImagePath(time, team, wardType);

      // Set the error handler BEFORE assigning src to avoid loops
      heatmapImage.onerror = function() {
        this.onerror = null; // Disable handler to prevent recursion
        this.src = 'heatmap_folder/heatmap_defaut.jpg';
      };

      // Use the preloaded image if available, otherwise load directly (fallback will activate on error)
      if (cacheImages[key] && cacheImages[key][time] !== null) {
        heatmapImage.src = cacheImages[key][time].src;
      } else {
        heatmapImage.src = imagePath;
      }
    }

    function togglePlay() {
      if (isPlaying) {
        clearInterval(interval);
        playPauseButton.textContent = "Play";
      } else {
        interval = setInterval(() => {
          let newTime = parseInt(timeInput.value) + 1;
          if (newTime > 500) newTime = 0;
          timeInput.value = newTime;
          timeSlider.value = newTime;
          updateHeatmap();
        }, 1000 / parseFloat(speedSelect.value));
        playPauseButton.textContent = "Pause";
      }
      isPlaying = !isPlaying;
    }

    timeInput.addEventListener("input", () => {
      timeSlider.value = timeInput.value;
      updateHeatmap();
    });

    timeSlider.addEventListener("input", () => {
      timeInput.value = timeSlider.value;
      updateHeatmap();
    });

    teamSelect.addEventListener("change", () => {
      const team = teamSelect.value;
      const wardType = wardSelect.value;
      preloadAllImages(team, wardType);
      updateHeatmap();
    });

    wardSelect.addEventListener("change", () => {
      const team = teamSelect.value;
      const wardType = wardSelect.value;
      preloadAllImages(team, wardType);
      updateHeatmap();
    });

    speedSelect.addEventListener("change", () => {
      if (isPlaying) {
        clearInterval(interval);
        togglePlay();
        togglePlay();
      }
    });

    playPauseButton.addEventListener("click", togglePlay);

    // Load JSON and configure the spacebar listener
    window.addEventListener("load", () => {
      console.log("Load event triggered");

      // First, fetch the JSON
      fetch('infos.json')
        .then(response => response.json())
        .then(data => {
          console.log("JSON Data received:", data);
          gameInfoDiv.innerHTML = `<br>
            <div style="line-height: 1.2; margin: 0.5em 0;">
              <p>Game Version: ${data.version}</p>
              <p>Number of Games Studied: ${data.numGames}</p>
              <p>Rank: ${data.rank}</p>
              <p>Last Update: ${data.lastUpdate}</p>
            </div>
          <br>`;
          contactInfoDiv.innerHTML = data.contactMessage;

          // Once the JSON is loaded, start preloading images
          const team = teamSelect.value;
          const wardType = wardSelect.value;
          preloadAllImages(team, wardType);
          updateHeatmap();
        })
        .catch(error => {
          console.error("Error loading JSON data:", error);
          // Even if there's an error, start preloading images to avoid blocking the app
          const team = teamSelect.value;
          const wardType = wardSelect.value;
          preloadAllImages(team, wardType);
          updateHeatmap();
        });
      
      // Spacebar listener
      document.addEventListener("keydown", (event) => {
        if (event.code === "Space") {
          event.preventDefault();
          togglePlay();
        }
      });
    });
  </script>
</body>
</html>
